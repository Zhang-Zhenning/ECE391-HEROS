#include <stdint.h>
#include "ece391support.h"
#include "ece391syscall.h"

// music scores: frequency in hz and duration in ms
int32_t freq_default[] = {1047, 1175, 1319, 1175, 1047};
int32_t dura_default[] = {200, 200, 200, 200, 200};
int32_t freq_bh[] = {659, 784, 659, 659, 880, 659, 587, 659, 988, 659, 659, 1047, 988, 784, 659, 988,
                     1318, 659, 587, 587, 494, 740, 659};
int32_t dura_bh[] = {460, 340, 230, 110, 230, 230, 230, 460, 340, 230, 110, 230, 230, 230, 230, 230, 230,
                     110, 230, 110, 230, 230, 460};
int32_t freq_myth[]={82, 104, 123, 165, 82, 104, 123, 165, 104, 123, 165, 208, 104, 123, 165, 208, 123, 165, 208, 247,
                     123, 165, 208, 247, 165, 208, 247, 330, 165, 208, 247, 330, 82, 110, 131, 165, 82, 110, 131, 165,
                     110, 131, 165, 220, 110, 131, 165, 220, 131, 165, 220, 262, 165, 220, 262, 330, 220, 262, 330, 440,
                     220, 131, 330, 440, 165, 208, 247, 330, 165, 208, 247, 330, 208, 247, 330, 415, 208, 247, 330, 415,
                     247, 330, 415, 494, 247, 330, 415, 494, 330, 415, 494, 659, 330, 415, 494, 659, 165, 220, 262, 330,
                     165, 220, 262, 330, 220, 262, 330, 440, 220, 262, 330, 440, 262, 330, 440, 523, 330, 440, 523, 659,
                     440, 523, 659, 880, 440, 262, 659, 880, 659, 262, 220, 587, 220, 165, 523, 262, 330, 262, 494, 262,
                     523, 165, 220, 440, 659, 262, 220, 587, 220, 165, 523, 262, 330, 262, 494, 262, 523, 165, 220, 440,
                     659, 294, 220, 587, 220, 175, 523, 294, 175, 220, 494, 220, 523, 294, 220, 349, 659, 208, 247, 587,
                     330, 247, 523, 247, 208, 247, 494, 247, 523, 330, 247, 330, 659, 262, 220, 587, 220, 165, 523, 262,
                     330, 262, 494, 262, 523, 165, 220, 440, 659, 262, 220, 587, 220, 165, 523, 262, 330, 262, 494, 262,
                     523, 165, 220, 440, 659, 294, 220, 587, 220, 175, 523, 294, 175, 220, 494, 220, 523, 294, 220, 349,
                     659, 208, 247, 587, 330, 247, 523, 247, 208, 247, 494, 247, 523, 330, 247, 330, 659, 440, 659, 440,
                     659, 440, 659, 440, 82};
int32_t dura_myth[]={120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120,
                     120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120,
                     120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120,
                     120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120,
                     120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120,
                     120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120,
                     120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120,
                     120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120,
                     120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120,
                     120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120,
                     120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120,
                     120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120,
                     120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 60, 60, 60, 60, 60,
                     60, 60, 60, 120};

/**
 * @brief generate the sound at a given frequency for a given duration (approximately)
 * @param freq frequency in hz
 * @param dura duration in ms
 * @side_effect open rtc and change frequency
 */
void beep(uint32_t freq, uint32_t dura) {
    int i;
    uint8_t dum[] = "d";
    uint8_t buf[] = "rtc";
    uint32_t t = 32;
    // set the rtc
    int dev_rtc = ece391_open(buf);
    ece391_write(dev_rtc, &t, 4);
    if (dev_rtc == -1) {
        ece391_fdputs (1, (uint8_t*)"In beep(): fail to set RTC.\n");
        return;
    }
    // play the music
    ece391_play_sound(freq);
    for (i = 0; i < dura; i++) ece391_read(dev_rtc, dum, 1);
    ece391_nosound();
    ece391_close(dev_rtc);
}

int32_t main(){
    uint8_t arg_buf[1024];
    if (0 != ece391_getargs(arg_buf, 1024)) {
        ece391_fdputs (1, (uint8_t*)"Fail in reading args\n");
        return -1;
    }

    // parse the arguments
    int i;
    int32_t arg_len = 0;
    uint8_t arg_music[128];
    for (i = 0; i < 1024; i++){
        if (arg_buf[i] != ' ') break;
    }
    for (; i < 128; i++){
        if (arg_buf[i] == ' ' || arg_buf[i] == '\0' ){
            break;
        } else {
            arg_music[arg_len++]=arg_buf[i];
        }
    }
    if (arg_len == 0) return -1;

    // translate ascii to number
    uint32_t music_num = 0;
    int32_t pow = 1;
    for (i = 0; i < arg_len; i++) {
        if (arg_music[arg_len - i - 1] < '0' || arg_music[arg_len - i - 1] > '9') return -1;
        music_num += (arg_music[arg_len - i - 1] - '0') * pow;
        pow *= 10;
    }

    if (music_num == -1 || arg_len == 0){
        ece391_fdputs (1, (uint8_t*)"Format: music <number> \n");
        return -1;
    }

    // play the right music, 23, 265, 5 are lengths
    switch (music_num){
        case 1:
            // div 32 because the frequency is set to 32 rather than 1024
            for (i=0; i<23; i++) beep(freq_bh[i], dura_bh[i] / 32);
            break;
        case 2:
            for (i=0; i<265; i++) beep(freq_myth[i], dura_myth[i] / 32);
            break;
        default:
            for (i=0; i<5; i++) beep(freq_default[i], dura_default[i] / 32);
            break;
    }

    return 0;
}
